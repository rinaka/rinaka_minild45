; Making tiled screens in 32x24 text mode
; note: programmed for the MSX1
; tested in openMSX using C-BIOS
; usage: openmsx -machine C-BIOS_MSX1 -cart <name>

; In this case we are using the top 128 characters
; as tiles. We also rewrite the colors for those
; characters so we can have colored tiles!

; some useful BIOS functions
GTSTCK:		equ	0x00d5
GTTRIG:		equ	0x00d8
INIT32:		equ	0x006f
LDIRVM:		equ	0x005c
WRTVDP:		equ	0x0087

; BIOS-used variables
BDRCLR:		equ	0xf3eb
BAKCLR:		equ	0xf3ea
FORCLR:		equ	0xf3e9

; VRAM addreses
CLRTAB:		equ	0x2010 ; top 16 entries of the color table
NAMTAB:		equ	0x1800
PATTAB:		equ	0x0400 ; top half of the pattern table
SPRATR:		equ	0x1b00
SPRPAT:		equ	0x3800

; Our program variables
spry:		equ	0xe000
sprx:		equ	spry+1
sprn:		equ	sprx+1
sprc:		equ	sprn+1

		org	0x4000

; cartridge header

		dw	0x4241
		dw	main
		ds	12

main:
		di

		im	1
		ld	sp, 0xf380
		
		; initialize variables
		ld	hl, sprini
		ld	de, spry
		ld	bc, 4
		ldir

		; enter graphics mode
		ld	hl, 0x0f04
		ld	(BAKCLR), hl
		ld	a, 0x04
		ld	(FORCLR), a
		call	INIT32
		ld	hl, basclr
		ld	de, CLRTAB
		ld	bc, 16
		call	LDIRVM
		ld	hl, baspat
		ld	de, PATTAB
		ld	bc, 1024
		call	LDIRVM
		ld	hl, basnam
		ld	de, NAMTAB
		ld	bc, 768
		call	LDIRVM
		ld	hl, sprite0
		ld	de, SPRPAT
		ld	bc, 8
		call	LDIRVM
		ld	hl, spry
		ld	de, SPRATR
		ld	bc, 4
		call	LDIRVM

		ei

mainloop:
		ld	a, 0	;xor	a
		call	GTSTCK
		ld	b, 1
		cp	b
		jr	nz, chkright
		ld	a, (spry)
		dec	a
		ld	(spry), a
		jr	updspr
chkright:	
		inc	b
		inc	b
		cp	b
		jr	nz, chkdown
		ld	a, (sprx)
		inc	a
		ld	(sprx), a
		jr	updspr
chkdown:	
		inc	b
		inc	b
		cp	b
		jr	nz, chkleft
		ld	a, (spry)
		inc	a
		ld	(spry), a
		jr	updspr
chkleft:
		inc	b
		inc	b
		cp	b
		jr	nz, mainloop
		ld	a, (sprx)
		dec	a
		ld	(sprx), a

updspr:		ld	a, 0
		ld	hl, spry
		ld	de, SPRATR
		ld	bc, 4
		call	LDIRVM

		; pause until an interrupt occurs
		halt
		jr	mainloop

; initialization data
sprini:
		dm	100, 0, 0, 10

; sprite banks
sprite0:	
		dm	0x3c, 0x7e, 0xdb, 0xff, 0xbd, 0xdb, 0x66, 0x3c

; colors to be copied to the color table
basclr:
		dm	0xc1, 0x6e, 0x31, 0x41, 0x51, 0x61, 0x71, 0x81
		dm	0x11, 0x21, 0x31, 0x41, 0x51, 0x61, 0x71, 0x81

; tiles to be copied to the pattern table
baspat:
		ds	64, 0xff
		dm	0xee, 0xee, 0x00, 0x77, 0x77, 0x00, 0xee, 0xee
		dm	0x77, 0x77, 0x00, 0xee, 0xee, 0x00, 0x77, 0x77
		dm	0x00, 0x77, 0x77, 0x00, 0x00, 0xee, 0xee, 0x00
		dm	0x00, 0xee, 0xee, 0x00, 0x00, 0x77, 0x77, 0x00
		ds	928, 0xff

; screen layout to be copied to the name table
basnam:
dm	0x80, 0x80, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x80, 0x80
dm	0x80, 0x80, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80
dm	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80

; filler for 32kB cartridge
		ds 	0c000h - $,0xff

