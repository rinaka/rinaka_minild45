; Cell-based movement
; note: programmed for the MSX1
; tested in openMSX using C-BIOS
; usage: openmsx -machine C-BIOS_MSX1 -cart <name>

; some useful BIOS functions
GTSTCK:         equ 0x00d5
GTTRIG:         equ 0x00d8
INIT32:         equ 0x006f
LDIRVM:         equ 0x005c
WRTVDP:         equ 0x0087

; BIOS-used variables
BDRCLR:         equ 0xf3eb
BAKCLR:         equ 0xf3ea
FORCLR:         equ 0xf3e9

; VRAM addreses
CLRTAB:         equ 0x2010 ; top 16 entries of the color table
NAMTAB:         equ 0x1800
PATTAB:         equ 0x0400 ; top half of the pattern table
SPRATR:         equ 0x1b00
SPRPAT:         equ 0x3800

; Our program variables
spry:           equ 0xe000
sprx:           equ spry+1
sprn:           equ sprx+1
sprc:           equ sprn+1

movestate:      equ sprc+1
movedir:        equ movestate+1

        org     0x4000

; cartridge header

        dw      0x4241
        dw      main
        ds      12

main:
        di

        im      1
        ld      sp, 0xf380
        
        ; initialize variables
        ld      hl, sprini
        ld      de, spry
        ld      bc, 6
        ldir

        ; enter graphics mode
        ld      hl, 0x0401
        ld      (BAKCLR), hl
        ld      a, 0x0f
        ld      (FORCLR), a
        call    INIT32
        ld      hl, basclr
        ld      de, CLRTAB
        ld      bc, 16
        call    LDIRVM
        ld      hl, baspat
        ld      de, PATTAB
        ld      bc, 1024
        call    LDIRVM
        ld      hl, basnam
        ld      de, NAMTAB
        ld      bc, 768
        call    LDIRVM
        ld      hl, sprite0
        ld      de, SPRPAT
        ld      bc, 8
        call    LDIRVM
        ld      hl, spry
        ld      de, SPRATR
        ld      bc, 4
        call    LDIRVM

        ei

mainloop:
        ld      a, (movestate)
        cp      0
        jr      nz, simul
        call    getmove
        cp      0
        jr      z, skipall
simul:
        dec     a
        ld      (movestate), a
        ld      a, (movedir)
        cp      1
        jr      nz, simul2
        ld      a, (spry)
        dec     a
        ld      (spry), a
        jr      updspr
simul2:
        cp      3
        jr      nz, simul3
        ld      a, (sprx)
        inc     a
        ld      (sprx), a
        jr      updspr
simul3: 
        cp      5
        jr      nz, simul4
        ld      a, (spry)
        inc     a
        ld      (spry), a
        jr      updspr
simul4:
        cp      7
        jr      nz, skipall
        ld      a, (sprx)
        dec     a
        ld      (sprx), a
updspr:
        ld      a, 0
        ld      hl, spry
        ld      de, SPRATR
        ld      bc, 4
        call    LDIRVM
        ; pause until an interrupt occurs
skipall:
        halt
        jr      mainloop

getmove:
        xor     a
        call    GTSTCK
        cp      1
        jr      nz, sub2
        ld      b, a
        ld      a, (spry)
        add     217
        jr      c, save
        jr      sub5
sub2:        
        cp      3
        jr      nz, sub3
        ld      b, a
        ld      a, (sprx)
        add     40
        jp      nc, save
        jr      sub5
sub3:
        cp      5
        jr      nz, sub4
        ld      b, a
        ld      a, (spry)
        add     89
        jp      nc, save
        jr      sub5
sub4:
        cp      7
        jr      nz, sub5
        ld      b, a
        ld      a, (sprx)
        add     217
        jr      c, save
sub5:
        xor     a
        ret
save:
        ld      a, b
        ld      (movedir), a
        ld      a, 8
        ld      (movestate), a
        ret

; initialization data
sprini:
        dm      79, 40, 0, 1, 0, 0

; sprite banks
sprite0:    
        dm      0x3c, 0x7e, 0xdb, 0xff, 0xbd, 0xdb, 0x66, 0x3c

; colors to be copied to the color table
basclr:
        dm      0x3c, 0x6e, 0x31, 0x41, 0x51, 0x61, 0x71, 0x81
        dm      0x11, 0x21, 0x31, 0x41, 0x51, 0x61, 0x71, 0x81

; tiles to be copied to the pattern table
baspat:
        dm      0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55, 0xaa, 0x55
        ds      56, 0xff
        dm      0xee, 0xee, 0x00, 0x77, 0x77, 0x00, 0xee, 0xee
        dm      0x77, 0x77, 0x00, 0xee, 0xee, 0x00, 0x77, 0x77
        dm      0x00, 0x77, 0x77, 0x00, 0x00, 0xee, 0xee, 0x00
        dm      0x00, 0xee, 0xee, 0x00, 0x00, 0x77, 0x77, 0x00
        ds      928, 0xff

; screen layout to be copied to the name table
basnam:
        dm      "  LITTLE MSX ADVENTURE          "
        dm      0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20
        dm      0x20, 0x20, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x20, 0x20
        dm      0x20, 0x20, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x20, 0x20
        dm      0x20, 0x20, 0x88, 0x89, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x88, 0x89, 0x20, 0x20
        dm      0x20, 0x20, 0x8a, 0x8b, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x8a, 0x8b, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x20, 0x20
        dm      0x20, 0x20, 0x88, 0x89, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x88, 0x89, 0x20, 0x20
        dm      0x20, 0x20, 0x8a, 0x8b, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x8a, 0x8b, 0x20, 0x20
        dm      0x20, 0x20, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x89, 0x20, 0x20
        dm      0x20, 0x20, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x8a, 0x8b, 0x20, 0x20

; filler for 32kB cartridge
        ds      0c000h - $,0xff

